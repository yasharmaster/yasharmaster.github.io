<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <title>PathQuery To Cypher - Part 2</title>
    <meta name="description" content="In this post I’ll present the approach that I am using for the converting Path Query to Cypher. The basics of Path Query to Cypher conversion have been discu...">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://yasharmaster.github.io/blog/2017/path-query-cypher-puzzle-part-2/">
    <link rel="alternate" type="application/rss+xml" title="Yash Sharma" href="http://yasharmaster.github.io/feed.xml" />
    <script src="http://fast.eager.io/ehZJ0e6K5k.js"></script>
  </head>

  <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>PathQuery To Cypher - Part 2 - Yash Sharma</title>
<meta property="og:title" content="PathQuery To Cypher - Part 2" />
<meta name="description" content="In this post I’ll present the approach that I am using for the converting Path Query to Cypher. The basics of Path Query to Cypher conversion have been discussed in my previous post." />
<meta property="og:description" content="In this post I’ll present the approach that I am using for the converting Path Query to Cypher. The basics of Path Query to Cypher conversion have been discussed in my previous post." />
<link rel="canonical" href="http://yasharmaster.github.io/blog/2017/path-query-cypher-puzzle-part-2/" />
<meta property="og:url" content="http://yasharmaster.github.io/blog/2017/path-query-cypher-puzzle-part-2/" />
<meta property="og:site_name" content="Yash Sharma" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-06-26T13:30:00+05:30" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "PathQuery To Cypher - Part 2",
    "datePublished": "2017-06-26T13:30:00+05:30",
    "description": "In this post I’ll present the approach that I am using for the converting Path Query to Cypher. The basics of Path Query to Cypher conversion have been discussed in my previous post.",
    "url": "http://yasharmaster.github.io/blog/2017/path-query-cypher-puzzle-part-2/"
  }
</script>
<!-- End Jekyll SEO tag -->
  <body>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');
</script>

    <main>
      <header class="site-header">
  <div class="container">
    <h1><a href="/">Yash <span>Sharma</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
          <li><a href="/about" title="About">About</a></li>
        
          <li><a href="/resume" title="Resume">Resume</a></li>
        
          <li><a href="/blog" title="Blog">Blog</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i></a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>


      <div class="container">
        <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">PathQuery To Cypher - Part 2</h1>
      <p class="post-meta">Jun 26, 2017</p>
    </header>

    <div class="post-content">
      <p>In this post I’ll present the approach that I am using for the converting Path Query to Cypher. The basics of Path Query to Cypher conversion have been discussed in my <a href="/blog/2017/path-query-cypher-puzzle/">previous post</a>.</p>

<h2 id="observations">Observations</h2>

<p>A Path Query consists of many <em>paths</em>. Each path represents some data in the database. For example consider the following Path Query.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;query</span> <span class="na">model=</span><span class="s">&quot;genomic&quot;</span> <span class="na">view=</span><span class="s">&quot;Gene.length Gene.homologues.dataSets.publication.title&quot;</span> <span class="na">constraintLogic=</span><span class="s">&quot;(A and B)&quot;</span><span class="nt">&gt;</span>
	<span class="nt">&lt;constraint</span> <span class="na">path=</span><span class="s">&quot;Gene.homologues.evidence.publications.abstractText&quot;</span> <span class="na">value=</span><span class="s">&quot;a&quot;</span> <span class="na">op=</span><span class="s">&quot;CONTAINS&quot;</span> <span class="na">code=</span><span class="s">&quot;A&quot;</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;constraint</span> <span class="na">path=</span><span class="s">&quot;Gene.homologues.dataSets.name&quot;</span> <span class="na">value=</span><span class="s">&quot;a&quot;</span> <span class="na">op=</span><span class="s">&quot;CONTAINS&quot;</span> <span class="na">code=</span><span class="s">&quot;B&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/query&gt;</span></code></pre></figure>

<p>It contains the following four paths.</p>

<ul>
  <li><code>Gene.length</code></li>
  <li><code>Gene.homologues.dataSets.name</code></li>
  <li><code>Gene.homologues.dataSets.publication.title</code></li>
  <li><code>Gene.homologues.evidence.publications.abstractText</code></li>
</ul>

<p>One observation that we can make by looking at these paths is that some prefixes are common in paths. For example, <code>Gene.homologues</code> is common in the last three, <code>Gene.homologues</code> is common is the second &amp; third and <code>Gene</code> prefix is there in all of them.</p>

<p>Infact, while building queries in the query builder, we start from a model and add its attributes, references &amp; collections to our query. Then we move on to any of the references/collections and then add its attributes, references &amp; collections to our Path Query as required, and so on. Thus, all the paths <em>will</em> have some prefix in common and there is an <em>heirarchy</em> associated with different components of the path.</p>

<p>With a bit of thought, I came to a conclusion that <a href="https://en.wikipedia.org/wiki/Tree_(data_structure)"><em>Tree Data Structure</em></a> would be the perfect representation for all the paths of the Path Query. Tree is a popular hierarchical data structure which has a root, subtrees of children with a parent node.</p>

<p><img src="/images/tree-data-structure.png" alt="Tree Data Structure" /></p>

<h2 id="pathtree-representation">PathTree Representation</h2>

<p>Let us generate a <em>Tree</em> using the four paths of the example Path Query shown above. Since it is a Tree made up of paths, we can call it a Path Tree.</p>

<p><img src="/images/PathTree.png" alt="A Path Tree" /></p>

<p>A path tree is made up of many <em>TreeNodes</em>. Each tree node represents a component of the path. For example, the path <code>Gene.homologues.dataSets.name</code> would be represented by four TreeNodes - Gene, homologues, dataSets &amp; name. These components further represent the Nodes, Relationships &amp; Properties in the InterMine Neo4j graph. These TreeNodes also represent Neo4j Graphical Entities (&amp; properties). All the paths having common prefix have common ancestor TreeNodes in the PathTree. This way we can represent hierachy among the various components of the path and can avoid storing redundant information.</p>

<h2 id="generating-cypher-using-path-tree">Generating Cypher using Path Tree</h2>

<p>In Cypher, we can assign Nodes, Relationships &amp; even Paths to the variables. These variables can then be used in place of those Nodes/Relationships/Paths in the rest of the query. For example consider an example Cypher query.</p>

<figure class="highlight"><pre><code class="language-cypher" data-lang="cypher"><span class="k">MATCH</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">Gene</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="err">-</span><span class="o">[</span><span class="n">r</span><span class="p">:</span><span class="n">locatedOn</span><span class="o">]</span><span class="err">-</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">Chromosome</span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="m">12345</span><span class="w"></span>
<span class="k">RETURN</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">symbol</span><span class="w"></span></code></pre></figure>

<p>In the example, we first matched all the <em>Genes</em> and assigned it to the variable <code>n</code>. Now, <code>n</code> is used to <em>MATCH</em> a relationship from <em>Genes</em> to <em>Chromosomes</em> and also in the <em>WHERE</em> clause it is used to compare the length of the Genes.</p>

<p>This way, while converting a Path Query to Cypher, we can assign a unique variable name to each <em>TreeNode</em> in the Path Tree and then use it in the remaining MATCH, WHERE, RETURN, ORDER BY &amp; OPTIONAL MATCH clauses. The <em>high-level</em> approach, in an algorithmic form is presented as follows.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="mf">1.</span> <span class="n">Take</span> <span class="n">a</span> <span class="n">PathQuery</span> <span class="n">object</span> <span class="n">as</span> <span class="n">input</span><span class="p">.</span>
<span class="mf">2.</span> <span class="n">Retrieve</span> <span class="n">the</span> <span class="n">following</span> <span class="n">information</span> <span class="n">from</span> <span class="n">the</span> <span class="n">PathQuery</span>
	<span class="mf">1.</span> <span class="n">Views</span>
	<span class="mf">2.</span> <span class="n">Constraints</span>
	<span class="mf">3.</span> <span class="n">Sort</span> <span class="n">Order</span>
<span class="mf">3.</span> <span class="n">Retrieve</span> <span class="n">all</span> <span class="n">the</span> <span class="n">Paths</span> <span class="n">from</span> <span class="n">the</span> <span class="n">Views</span><span class="p">,</span> <span class="n">Constraints</span> <span class="o">&amp;</span> <span class="n">Sort</span> <span class="n">Order</span><span class="p">.</span>
<span class="mf">4.</span> <span class="n">Using</span> <span class="n">the</span> <span class="n">Paths</span><span class="p">,</span> <span class="n">create</span> <span class="n">a</span> <span class="n">PathTree</span> <span class="p">(</span><span class="n">please</span> <span class="n">refer</span> <span class="n">image</span> <span class="n">attached</span><span class="p">)</span> <span class="n">such</span> <span class="n">that</span> 
	<span class="mf">1.</span> <span class="n">Each</span> <span class="n">TreeNode</span> <span class="n">represents</span> <span class="n">a</span> <span class="n">component</span> <span class="n">of</span> <span class="n">the</span> <span class="n">path</span><span class="p">.</span> <span class="n">For</span> <span class="n">example</span><span class="p">,</span> <span class="n">the</span> <span class="n">path</span> <span class="s">&quot;Gene.pathways.identifier&quot;</span> <span class="n">forms</span> <span class="n">three</span> <span class="n">TreeNodes</span> <span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.</span> <span class="n">Gene</span><span class="p">,</span> <span class="n">Pathways</span> <span class="o">&amp;</span> <span class="n">Identifier</span><span class="p">.</span>
	<span class="mf">2.</span> <span class="n">Paths</span> <span class="n">with</span> <span class="n">common</span> <span class="n">prefix</span> <span class="n">have</span> <span class="n">the</span> <span class="n">same</span> <span class="n">common</span> <span class="n">ancestor</span><span class="p">.</span>
	<span class="mf">3.</span> <span class="n">Root</span> <span class="n">TreeNode</span> <span class="n">represents</span> <span class="n">a</span> <span class="n">Graph</span> <span class="n">Node</span><span class="p">.</span>
	<span class="mf">4.</span> <span class="n">All</span> <span class="n">Leaves</span> <span class="n">of</span> <span class="n">the</span> <span class="n">PathTree</span> <span class="n">always</span> <span class="n">represent</span> <span class="n">Graph</span> <span class="n">Properties</span><span class="p">.</span>
	<span class="mf">5.</span> <span class="n">All</span> <span class="n">other</span> <span class="n">Internal</span> <span class="n">TreeNodes</span> <span class="n">can</span> <span class="n">represent</span> <span class="n">either</span> <span class="n">Graph</span> <span class="n">Nodes</span> <span class="n">or</span> <span class="n">Graph</span> <span class="n">Relationships</span><span class="p">.</span>
<span class="mf">5.</span> <span class="n">Assign</span> <span class="n">a</span> <span class="n">unique</span> <span class="n">variable</span> <span class="n">name</span> <span class="n">to</span> <span class="n">each</span> <span class="n">Internal</span> <span class="n">node</span> <span class="n">of</span> <span class="n">the</span> <span class="n">PathTree</span><span class="p">.</span>
	<span class="mf">1.</span> <span class="n">This</span> <span class="n">variable</span> <span class="n">name</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="k">for</span> <span class="n">referring</span> <span class="n">that</span> <span class="n">TreeNode</span> <span class="n">in</span> <span class="n">the</span> <span class="n">cypher</span> <span class="n">query</span><span class="p">.</span>
	<span class="mf">2.</span> <span class="n">For</span> <span class="n">generating</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">name</span><span class="p">,</span> <span class="n">we</span> <span class="n">can</span> <span class="n">separate</span> <span class="n">each</span> <span class="n">component</span> <span class="n">of</span> <span class="n">the</span> <span class="n">path</span> <span class="k">using</span> <span class="n">underscores</span><span class="p">.</span> <span class="n">For</span> <span class="n">example</span><span class="p">,</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">name</span> <span class="k">for</span> <span class="s">&quot;Gene.pathways.identifier&quot;</span> <span class="n">will</span> <span class="n">be</span> <span class="n">gene_pathways_identifier</span><span class="p">.</span>
<span class="mf">6.</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">PathTree</span> <span class="n">to</span> <span class="n">generate</span> <span class="n">the</span> <span class="n">cypher</span> <span class="n">query</span>
	<span class="mf">1.</span> <span class="n">For</span> <span class="n">creating</span> <span class="n">the</span> <span class="n">Match</span> <span class="n">Clause</span><span class="p">,</span>
		<span class="mf">1.</span> <span class="n">Simply</span> <span class="n">write</span> <span class="n">all</span> <span class="n">the</span> <span class="n">edges</span> <span class="n">of</span> <span class="n">the</span> <span class="n">tree</span> <span class="n">separated</span> <span class="n">by</span> <span class="n">commas</span> <span class="n">after</span> <span class="s">&quot;MATCH&quot;</span> <span class="n">keyword</span><span class="p">.</span>
		<span class="mf">2.</span> <span class="n">Add</span> <span class="n">variable</span> <span class="n">name</span> <span class="n">assigned</span> <span class="n">in</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">step</span> <span class="n">to</span> <span class="n">each</span> <span class="n">entity</span> <span class="n">in</span> <span class="n">cypher</span><span class="p">.</span>
	<span class="mf">2.</span> <span class="n">For</span> <span class="n">creating</span> <span class="n">the</span> <span class="n">WHERE</span> <span class="n">clause</span><span class="p">,</span>
		<span class="mf">1.</span> <span class="n">For</span> <span class="n">each</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">get</span> <span class="n">its</span> <span class="n">path</span><span class="p">,</span> <span class="k">operator</span> <span class="o">&amp;</span> <span class="n">value</span><span class="p">.</span>
		<span class="mf">2.</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">variableName</span> <span class="n">of</span> <span class="n">the</span> <span class="n">last</span> <span class="n">TreeNode</span> <span class="n">of</span> <span class="n">the</span> <span class="n">path</span><span class="p">.</span>
		<span class="mf">3.</span> <span class="n">Add</span> <span class="s">&quot;&lt;variableName&gt; &lt;operator&gt; &lt;value&gt;&quot;</span> <span class="n">after</span> <span class="n">the</span> <span class="s">&quot;WHERE&quot;</span> <span class="n">keyword</span>
		<span class="mf">4.</span> <span class="n">Add</span> <span class="n">operators</span> <span class="n">in</span> <span class="n">between</span> <span class="n">each</span> <span class="n">constraint</span> <span class="n">as</span> <span class="n">per</span> <span class="n">the</span> <span class="n">constraint</span> <span class="n">logic</span><span class="p">.</span>
	<span class="mf">3.</span> <span class="n">For</span> <span class="n">creating</span> <span class="n">the</span> <span class="n">RETURN</span> <span class="n">clause</span>
		<span class="mf">1.</span> <span class="n">For</span> <span class="n">each</span> <span class="n">view</span><span class="p">,</span> <span class="n">get</span> <span class="n">its</span> <span class="n">path</span>
		<span class="mf">2.</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">variableName</span> <span class="n">of</span> <span class="n">the</span> <span class="n">last</span> <span class="n">TreeNode</span> <span class="n">of</span> <span class="n">the</span> <span class="n">path</span>
		<span class="mf">3.</span> <span class="n">Add</span> <span class="n">variableNames</span> <span class="n">separated</span> <span class="n">by</span> <span class="n">commas</span> <span class="k">for</span> <span class="n">each</span> <span class="n">such</span> <span class="n">variable</span>
	<span class="mf">4.</span> <span class="n">For</span> <span class="n">creating</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">clause</span><span class="p">,</span>
		<span class="mf">1.</span> <span class="n">For</span> <span class="n">each</span> <span class="n">Sort</span> <span class="n">Order</span><span class="p">,</span> <span class="n">get</span> <span class="n">its</span> <span class="n">path</span>
		<span class="mf">2.</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">variableName</span> <span class="n">of</span> <span class="n">the</span> <span class="n">last</span> <span class="n">TreeNode</span> <span class="n">of</span> <span class="n">the</span> <span class="n">path</span>
		<span class="mf">3.</span> <span class="n">Add</span> <span class="n">variableName</span> <span class="n">ASC</span><span class="o">/</span><span class="n">DESC</span> <span class="n">separated</span> <span class="n">by</span> <span class="n">commas</span> <span class="k">for</span> <span class="n">each</span> <span class="n">such</span> <span class="n">variable</span>
	<span class="mf">5.</span> <span class="n">For</span> <span class="n">handling</span> <span class="n">JOIN</span> <span class="n">operations</span> <span class="n">in</span> <span class="n">the</span> <span class="n">PathQuery</span><span class="p">,</span>
		<span class="mf">1.</span> <span class="n">Add</span> <span class="n">OPTIONAL</span> <span class="n">MATCH</span> <span class="n">clause</span> <span class="n">in</span> <span class="n">the</span> <span class="n">query</span> <span class="k">for</span> <span class="n">corresponding</span> <span class="n">paths</span><span class="p">.</span>
<span class="mf">7.</span> <span class="n">Return</span> <span class="n">the</span> <span class="n">generated</span> <span class="n">query</span></code></pre></figure>

<p>In the next post, I’ll explain the generation of each clause - MATCH, RETURN, ORDER BY, WHERE &amp; OPTIONAL MATCH separately. Meanwhile, you can have a look at the Path Query to Cypher conversion code at <a href="https://github.com/intermine/neo4j/tree/dev/src/org/intermine/neo4j/cypher">org.intermine.neo4j.cypher</a> package.</p>

    </div>

    
<hr>

<aside id="comments" class="disqus">
  <div class="container">
    <h3><i class="icon icon-comments-o"></i> Comments</h3>
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function() {
        this.page.url = 'http://yasharmaster.github.io';
        this.page.identifier = '/blog/2017/path-query-cypher-puzzle-part-2';
      };
      (function() {
        var d = document,
        s = d.createElement('script');
        s.src = '//www-yashsharma-tech.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</aside>

  </div>

</article>

      </div>

      <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="http://github.com/yasharmaster" target="_blank"><i class="icon icon-github"></i></a></li>
  <li><a href="http://twitter.com/yashsharma260" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="http://facebook.com/yasharma.95" target="_blank"><i class="icon icon-facebook"></i></a></li>
  <li><a href="http://linkedin.com/in/yash-sharma-317367b9" target="_blank"><i class="icon icon-linkedin"></i></a></li>
</ul>
    <p class="txt-medium-gray">
      <small>&copy;2017 Yash Sharma. All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


      <a href="http://github.com/yasharmaster/yasharmaster.github.io" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#337ab7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

      <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
      <script>
      $(document).ready(function() {
        $('.sliding-panel-button,.sliding-panel-fade-screen,.sliding-panel-close').on('click touchstart',function (e) {
          $('.sliding-panel-content,.sliding-panel-fade-screen').toggleClass('is-visible');
          e.preventDefault();
        });
      });
      </script>
    </main>
  </body>
</html>
